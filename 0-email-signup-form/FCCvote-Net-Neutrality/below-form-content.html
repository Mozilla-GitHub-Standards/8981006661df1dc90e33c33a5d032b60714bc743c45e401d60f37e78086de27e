<!-- =================== Below form content STARTS =================== -->

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="https://sendto.mozilla.org/page/-/protect-net-neutrality/js/parsley.min.js"></script>
<script>

(function(){

  var $bsdForm = $("#signup"); // BSD autogenerated form
  var $theForm = $("#petition-signup-form"); // our beautified form

  // ***********************************************
  // Remove the BSD generated form from DOM
  // ***********************************************
  $(window).on("load", function () {
    $bsdForm.remove();
  });


  // ***********************************************
  // Display countdown counter
  // ***********************************************
  // the FCC votes in EST (Washington DC) and the date of the vote is February 26th.
  // So 8am EST on Feb 26th is a good date to countdown to
  var FORM_DUE_TIME = 1424955600000;  // countdown to Feb. 26 8am EST = 1424955600000 (Unix)

  var updateCountdown = function() {
    var userLocalTime = (new Date()).getTime();
    var daysAway = Math.floor( (FORM_DUE_TIME - userLocalTime) / 24 / 60 / 60 / 1000 );
    document.querySelector("#countdown-days span").innerHTML = daysAway;
  }
  setInterval(updateCountdown, 60*1000); // in milliseconds. update counter every min

  updateCountdown();

  // ***********************************************
  // Parsley Settings, Form Validation, & Form Validation
  // ***********************************************

  var $stateDropdown = $theForm.find("select[name='state_cd']");

  $("#one-line-error").hide();
  $("#petition-signup-form").parsley().subscribe('parsley:form:validated', function (formInstance) {
    if (formInstance.submitEvent !== undefined) {
      formInstance.submitEvent.preventDefault();
    }
    if (!formInstance.isValid()) {
      console.log("=== there's errorrrrr ===");
      formInstance.submitEvent.preventDefault();
      $("#one-line-error").show();
    } else {
      console.log("let's submit form===");
      // ***********************************************
      // Form Submission
      // ***********************************************

      var submitPetition = $.ajax($theForm.prop("action"), {
        type: "POST",
        data: $theForm.serializeArray(),
        statusCode: {
          400: submissionErrorHandler,
          500: submissionErrorHandler
        }

      });

      function submissionErrorHandler(XHR, textStatus, error) {
        $('#one-line-error').text("Something seems to have gone wrong. Please try again later").show();
      }

      function submitSuccess(data, textStatus, XHR) {
        alert("yah! before. data.redirect_url = " + data.redirect_url );
        if (window.location.assign) {
          window.location.assign(data.redirect_url);
        } else {
          window.location = data.redirect_url;
        }

        alert("yah! after");
      }

      function submitError(XHR, textStatus, error) {
      }

      submitPetition.error(submitError).success(submitSuccess);
    }
  });

  var toggleOneLineError = function() {
    console.log("tooooooggggle meeee!!!!!!!");
    var numErrors = $(".parsley-error").length;
    console.log("Num ERROR = " + numErrors);
    if ( numErrors > 0 ) {
      $("#one-line-error").show();
    } else {
      $("#one-line-error").hide();
    }
  };

  function updateDropdownTextColor(elem) {
    var selected = elem.val();
    console.log(selected);
    if ( selected ){
      elem.addClass("defaultTextColor");
    } else {
      elem.removeClass("defaultTextColor");
    }
  }

  updateDropdownTextColor($stateDropdown);

  $theForm.find("input").on("change", toggleOneLineError);
  $stateDropdown.on("change", toggleOneLineError);
  $stateDropdown.on("change", function (){
    // console.log("sup");
    updateDropdownTextColor($(this));
  });


})();

</script>

<!-- =================== Below form content ENDS =================== -->
