<!-- =================== Below form content STARTS =================== -->

<script>
  var bsdForm = $("form#contribution");
  var $bsdForm = bsdForm;
  var theForm = $("#donation-form");
  var $theForm = theForm;

  // To make the page show properly on mobile
  $("head").append("<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, user-scalable=no\">");

  // ***********************************************
  // UI related
  // ***********************************************
  $(".cc-additional-info").hide();
  $(".hint-msg").hide();
  $("form#contribution").hide();
  $("h2.temp-label").hide();

  $("#donation-form input, #donation-form select").focus(function() {
    $(this).siblings("i.fa.field-icon").addClass("icon-in-focus");
  });
  $("#donation-form input, #donation-form select").blur(function() {
    $(this).siblings("i.fa.field-icon").removeClass("icon-in-focus");
  });

  $("#payment-type-row label").click(function() {
    // reset
    $(".cc-additional-info").hide();
    // toggle corresponding section
    var paymentType = $(this).attr("for");
    if ( paymentType == "payment-cc" ) {
      $(".cc-additional-info").slideDown( "slow" );
    }
  });

  $("#mozilla-eoy-donation input#amount-other + label + input[type=\"text\"]").focus(function() {
    $(this).prevAll("input[type=\"radio\"]").click();
  });

  $("i.hint").click(function() {
    $(this).toggleClass("on");
    $(this).parents(".hint-msg-parent").find(".hint-msg").toggle();
  });


  // ***********************************************
  // Changing credit card logos on click / hover
  // Not an ideal way to swap the images. Probably should use CSS sprite when we get a chance
  // ***********************************************
  function coloredCCLogos() {
    $("#visa-logo").attr("src", "https://sendto.mozilla.org/page/-/donation_form/img/Visa.png");
      $("#mc-logo").attr("src", "https://sendto.mozilla.org/page/-/donation_form/img/MasterCard.png");
  }

  function whiteCCLogos() {
    $("#visa-logo").attr("src", "https://sendto.mozilla.org/page/-/donation_form/img/Visa-white.png");
      $("#mc-logo").attr("src", "https://sendto.mozilla.org/page/-/donation_form/img/MasterCard-white.png");
  }

  $("input[name='payment-type']").change(function() {
    var selected = $(this).val();
    if ( selected == "cc" ) {
      whiteCCLogos();
    } else {
      coloredCCLogos();
    }
  });

  $("label[for='payment-cc']").mouseover(function (){
    whiteCCLogos();
  });

  $("label[for='payment-cc']").mouseout(function (){
    coloredCCLogos();
  });

  // ***********************************************
  // Generate country dropdown.
  // This basically copies the BSD generated DOM.
  // ***********************************************
  function generateCountryDropdown() {
    var cloned = $bsdForm.find("select[name='country']").clone();
    $theForm.find("select[name='country']").html(cloned.html());
    $theForm.find("option:selected").removeAttr("selected");
    $theForm.find("option:first-child").attr("selected","selected").html("Country");
  }
  generateCountryDropdown();


  // ***********************************************
  // Extract BSD form meta and insert to our form
  // ***********************************************
  function insertFormMetaDOM() {
    // the following is an array of all the meta form field names that came with the BSD generated form
    // API doc here: https://github.com/bluestatedigital/bsd-developer-docs/blob/master/bsd-donate-api/README.md
    var bsdFormMetaName = [
                        "slug",            // required
                        "submission_key",
                        "http_referer",
                        "event_attendee_id",
                        "outreach_page_id",
                        "stg_signup_id",
                        "mailing_link_id",
                        "mailing_recipient_id",
                        "match_campaign_id",
                        "match_is_pledge",
                        "pledge_is_convert",
                        "contributor_key",
                        "quick_donate_populated",
                        "device_fingerprint",
                        "default_country",
                        "cc_number_ack",
                        "ach_account_number_ack",
                        "k-ris-sid"
                      ];

    var metaFieldsDOM = "";

    $.each(bsdFormMetaName, function( index, value ) {
      var field = $bsdForm.find("[name='"+ value + "']").clone();
      metaFieldsDOM += field[0].outerHTML;
    });

    $theForm.prepend(metaFieldsDOM);
    console.log("copy cloned fields done");
  }
  insertFormMetaDOM();


  // ***********************************************
  // Update Donate button to make it show the selected donation amount
  // ***********************************************
  var updateDonateButtonText = function(event) {
    var amountSelected = $(this).val();
    console.log(amountSelected);
    var buttonText = "Donate now";
    if ( amountSelected == "other" ) {
      amountSelected = $theForm.find("[name='amount_other']").val();
    }
    buttonText = amountSelected ? "Donate $" + amountSelected + " now" : "Donate now";
    $("#donate-btn").attr("value", buttonText);
  };

  $theForm.find("[name='amount']").change(updateDonateButtonText);
  $theForm.find("[name='amount_other']").keyup(updateDonateButtonText);
  $theForm.find("[name='amount_other']").keydown(function(event) {
    // console.log(event.keyCode);
    var functionKeys = [46, 8, 9, 27, 13, 110, 190]; // backspace, delete, tab, escape, enter and .
    var numberKeys = [ 48, 49, 50, 51, 52, 53, 54, 55, 56, 57 ]; // numbers
    var allowed = functionKeys.concat(numberKeys);
    // console.log(allowed.indexOf(event.keyCode));
    if ( allowed.indexOf(event.keyCode) === -1 ) {
      event.preventDefault();
    }
  });


  // ***********************************************
  // Parsley.js setting & client side validation etc
  // ***********************************************
  window.ParsleyConfig = {};

  $theForm.parsley().subscribe("parsley:form:validate", function (formInstance) {
    var toggleCCpanel = function() {
      console.log("clicked!!!!");
      var amountSelected = formInstance.isValid("amount", true);
      var paymentTypeSelected = formInstance.isValid("payment-type", true);
      if ( !$(".cc-additional-info").is(":visible") && amountSelected && paymentTypeSelected  ) {
        $(".cc-additional-info").slideDown( "slow" );
      }
    };

    $("#donate-btn").click(toggleCCpanel);
  });

  // ***********************************************
  // Remove the BSD generated form from DOM
  // ***********************************************
  // $bsdForm.remove();
</script>

<!-- =================== Below form content ENDS =================== -->
